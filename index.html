<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>B-EST CATALOG</title>
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>
</head>
<body>

<div id="intro" style="display: none;">
  <h1>B-EST</h1>
  <h2>CATALOG</h2>
  <button onclick="startCatalog()">í¼ì³ë³´ê¸°</button>
</div>

<div id="loading" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9998; display: flex; flex-direction: column; justify-content: center; align-items: center;">
  <img src="ë¹„ì—ìŠ¤íŠ¸ ë¡œê³ (ë”±ë§ê²Œ).png" alt="ë¡œë”© ì¤‘..." style="width: 60px; height: auto;">
  <span>ë¡œë”© ì¤‘...</span>
</div>

<div class="navbar">
  <div class="navbar-left">
    <span>B-EST CATALOG</span>
  </div>
  <div class="navbar-right">
    <button class="sound-toggle" id="soundToggle" onclick="toggleSound()">ğŸ”Š</button>
    <a href="https://www.bestnail.kr" target="_blank">
      <img src="ë¹„ì—ìŠ¤íŠ¸ ë¡œê³ (ë”±ë§ê²Œ).png" alt="ë¡œê³ ">ì‡¼í•‘ëª°
    </a>
  </div>
</div>

<div id="flipbook"></div>

<div class="nav-buttons">
  <button id="first">â®</button>
  <button id="prev">â¬… ì´ì „</button>
  <span class="page-number" id="page-number">1 / 83</span>
  <input type="number" id="pageInput" min="1" max="83" class="page-input" placeholder="í˜ì´ì§€" />
  <button id="next">ë‹¤ìŒ â¡</button>
  <button id="last">â­</button>
</div>

<audio id="flipSound" src="page-flip.mp3" preload="auto"></audio>

<script>
const totalPages = 83;
const pages = [];
let soundLevel = 0.5;
let resizeTimeout;
let lastPage = 1;

function buildPages(limit = totalPages) {
  pages.length = 0;
  for (let i = 1; i <= limit; i++) {
    const num = String(i).padStart(2, '0');
    pages.push(`<div class='page'><div style='position:relative; width:100%; height:100%;'><img src='${num}.jpg' loading='lazy' style='width:100%; height:100%; object-fit:contain;'/><div style='position:absolute; bottom:10px; width:100%; text-align:center; font-size:24px; font-weight:bold; color:#444;'>-${i}-</div></div></div>`);
  }
}

function waitForImages(callback) {
  const imgs = $("#flipbook img");
  let loaded = 0;
  if (imgs.length === 0) return callback();
  imgs.each(function () {
    if (this.complete) {
      if (++loaded === imgs.length) callback();
    } else {
      $(this).on("load error", function () {
        if (++loaded === imgs.length) callback();
      });
    }
  });
}

function getDisplayMode() {
  const isPortrait = window.innerHeight > window.innerWidth;
  return isPortrait ? 'single' : 'double';
}

function initializeFlipbook(startPage = 1, disableAnimation = false) {
  $("#loading").show();
  const flipbook = $("#flipbook");
  if (flipbook.data("turn")) flipbook.turn("destroy").html("");
  const screenWidth = window.innerWidth;
  const maxWidth = 1200;
  const width = Math.min(screenWidth * 0.95, maxWidth);
  const height = width * 1.3;
  const displayMode = getDisplayMode();

  flipbook.html(pages.join(""));
  waitForImages(() => {
    flipbook.turn({
      duration: disableAnimation ? 0 : 1200,
      width: displayMode === 'single' ? width : width * 2,
      height: height,
      display: displayMode,
      autoCenter: true,
      gradients: true,
      elevation: 50,
      acceleration: true,
    }).turn("page", startPage);
    updateButtons();
    $("#loading").hide();
  });

  setTimeout(() => {
    if (document.getElementById("loading").style.display !== "none") {
      localStorage.setItem('lastPage', lastPage || 1);
      location.reload();
    }
  }, 5000);
}

function updateButtons() {
  const loadedPages = pages.length;
  const current = $("#flipbook").turn("page");
  if (loadedPages < totalPages && current + 2 > loadedPages) {
    for (let i = loadedPages + 1; i <= Math.min(totalPages, loadedPages + 6); i++) {
      if (!pages[i - 1]) {
        const num = String(i).padStart(2, '0');
        pages[i - 1] = `<div class='page'><div style='position:relative; width:100%; height:100%;'><img src='${num}.jpg' loading='lazy' style='width:100%; height:100%; object-fit:contain;'/><div style='position:absolute; bottom:10px; width:100%; text-align:center; font-size:24px; font-weight:bold; color:#444;'>-${i}-</div></div></div>`;
      }
      if (!$("#flipbook").turn("hasPage", i)) {
        $("#flipbook").turn("addPage", $(pages[i - 1]), i);
      }
    }
  }
  const view = $("#flipbook").turn("view");
  const text = view.length > 1 ? `${Math.min(...view)}-${Math.max(...view)} / ${totalPages}` : `${current} / ${totalPages}`;
  $("#page-number").text(text);
  $("#prev").toggle(current > 1);
  $("#next").toggle(current < totalPages);
  lastPage = current;
}

function playFlipSound() {
  const audio = document.getElementById("flipSound");
  audio.volume = soundLevel;
  audio.currentTime = 0;
  audio.play().catch(() => {});
}

function toggleSound() {
  if (soundLevel === 0.5) {
    soundLevel = 0;
    document.getElementById("soundToggle").textContent = "ğŸ”‡";
  } else if (soundLevel === 0) {
    soundLevel = 1;
    document.getElementById("soundToggle").textContent = "ğŸ”Š";
  } else {
    soundLevel = 0.5;
    document.getElementById("soundToggle").textContent = "ğŸ”‰";
  }
}

function startCatalog(isAuto = false) {
  const saved = localStorage.getItem('lastPage');
  lastPage = saved ? parseInt(saved) : 1;
  document.getElementById("intro").style.display = "none";
  buildPages();
  initializeFlipbook(lastPage, isAuto);
}

$(document).ready(function () {
  $("#first").click(() => { $("#flipbook").turn("page", 1); playFlipSound(); });
  $("#last").click(() => { $("#flipbook").turn("page", totalPages); playFlipSound(); });
  $("#prev").click(() => { $("#flipbook").turn("previous"); playFlipSound(); });
  $("#next").click(() => { $("#flipbook").turn("next"); playFlipSound(); });

  $("#pageInput").on("keydown", function(e) {
    if (e.key === "Enter") {
      const val = parseInt($(this).val(), 10);
      if (!isNaN(val) && val >= 1 && val <= totalPages) {
        $("#flipbook").turn("page", val);
        playFlipSound();
      } else {
        alert("1ë¶€í„° " + totalPages + " ì‚¬ì´ì˜ í˜ì´ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      }
    }
  });

  $(window).on("resize orientationchange", () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      location.reload();
    }, 200);
  });

  $("#flipbook").on("turned", () => {
    updateButtons();
    playFlipSound();
  });

  let xDown = null;
  document.addEventListener("touchstart", function(evt) {
    xDown = evt.touches[0].clientX;
  }, false);

  document.addEventListener("touchmove", function(evt) {
    if (!xDown) return;
    const xUp = evt.touches[0].clientX;
    const xDiff = xDown - xUp;
    if (Math.abs(xDiff) > 50) {
      if (xDiff > 0) {
        $("#flipbook").turn("next");
      } else {
        $("#flipbook").turn("previous");
      }
      xDown = null;
    }
  }, false);

  const savedPage = localStorage.getItem('lastPage');
  if (savedPage) {
    startCatalog(true);
  } else {
    document.getElementById("intro").style.display = "flex";
  }
});
</script>
</body>
</html>
